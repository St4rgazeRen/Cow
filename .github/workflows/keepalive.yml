name: Streamlit Keepalive (é˜²ä¼‘çœ  Ping)

# ==============================================================================
# ç›®çš„: Streamlit Community Cloud å…è²»ç‰ˆ 7 å¤©ç„¡äººè¨ªå•å¾Œæœƒé€²å…¥ä¼‘çœ 
#       æ­¤ Workflow æ¯ 24 å°æ™‚è‡ªå‹• Ping ä¸€æ¬¡ Appï¼Œé˜²æ­¢ä¼‘çœ 
# è¨­å®š: è«‹åœ¨ GitHub Repo Settings â†’ Secrets â†’ Actions åŠ å…¥:
#       STREAMLIT_APP_URL = https://your-app-name.streamlit.app
# ==============================================================================

on:
  schedule:
    # æ¯å¤© UTC 08:00 åŸ·è¡Œ (å°ç£æ™‚é–“ 16:00)
    - cron: '0 8 * * *'
  workflow_dispatch:  # å…è¨±æ‰‹å‹•è§¸ç™¼

jobs:
  ping:
    name: Ping Streamlit App
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: æª¢æŸ¥ STREAMLIT_APP_URL æ˜¯å¦å·²è¨­å®š
        run: |
          if [ -z "${{ secrets.STREAMLIT_APP_URL }}" ]; then
            echo "âš ï¸  è­¦å‘Š: STREAMLIT_APP_URL æœªè¨­å®š"
            echo "è«‹è‡³ GitHub Repo Settings â†’ Secrets â†’ Actions æ–°å¢ž:"
            echo "  Name:  STREAMLIT_APP_URL"
            echo "  Value: https://your-app-name.streamlit.app"
            exit 1
          fi
          echo "âœ… STREAMLIT_APP_URL å·²è¨­å®š"

      - name: Ping App (ä¸»è¦è«‹æ±‚)
        id: ping_main
        run: |
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" \
            --max-time 30 \
            --retry 3 \
            --retry-delay 10 \
            "${{ secrets.STREAMLIT_APP_URL }}")
          echo "HTTP Status: $HTTP_CODE"
          echo "http_code=$HTTP_CODE" >> $GITHUB_OUTPUT

          if [[ "$HTTP_CODE" -ge 200 && "$HTTP_CODE" -lt 400 ]]; then
            echo "âœ… App å›žæ‡‰æ­£å¸¸ (HTTP $HTTP_CODE)"
          elif [[ "$HTTP_CODE" -eq 503 ]]; then
            echo "ðŸ˜´ App å¯èƒ½æ­£åœ¨å¾žä¼‘çœ ä¸­å–šé†’ (HTTP 503)"
            echo "ç­‰å¾… 30 ç§’å¾Œå†æ¬¡ç¢ºèª..."
            sleep 30
            HTTP_CODE2=$(curl -s -o /dev/null -w "%{http_code}" \
              --max-time 60 \
              "${{ secrets.STREAMLIT_APP_URL }}")
            echo "ç¬¬äºŒæ¬¡å˜—è©¦ HTTP Status: $HTTP_CODE2"
            if [[ "$HTTP_CODE2" -ge 200 && "$HTTP_CODE2" -lt 400 ]]; then
              echo "âœ… App å–šé†’æˆåŠŸ (HTTP $HTTP_CODE2)"
            else
              echo "âŒ App å–šé†’å¤±æ•— (HTTP $HTTP_CODE2)"
            fi
          else
            echo "âŒ App å›žæ‡‰ç•°å¸¸ (HTTP $HTTP_CODE)"
          fi

      - name: è¨˜éŒ„ Ping çµæžœæ‘˜è¦
        if: always()
        run: |
          echo "### ðŸ¤– Streamlit Keepalive å ±å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| é …ç›® | çµæžœ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| åŸ·è¡Œæ™‚é–“ | $(date -u '+%Y-%m-%d %H:%M UTC') |" >> $GITHUB_STEP_SUMMARY
          echo "| HTTP ç‹€æ…‹ | ${{ steps.ping_main.outputs.http_code }} |" >> $GITHUB_STEP_SUMMARY
          echo "| App URL | ${{ secrets.STREAMLIT_APP_URL }} |" >> $GITHUB_STEP_SUMMARY
