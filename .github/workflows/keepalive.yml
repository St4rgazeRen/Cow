name: Streamlit Keepalive (防休眠 Ping)

# Streamlit Community Cloud 只要收到 HTTP 流量就不休眠
# 無論回傳 200/301/503 都算「有人訪問」，不需要追蹤重定向
# 設定: GitHub Repo -> Settings -> Secrets -> Actions
#       加入 Secret: STREAMLIT_APP_URL
#       值: https://mfyyo9qf5mymsrouxkfdgj.streamlit.app

on:
  schedule:
    - cron: '0 0 * * *'   # UTC 00:00 (台灣 08:00)
    - cron: '0 12 * * *'  # UTC 12:00 (台灣 20:00)
  workflow_dispatch:

jobs:
  ping:
    name: Ping Streamlit App
    runs-on: ubuntu-latest
    timeout-minutes: 3

    steps:
      - name: Send keepalive ping
        env:
          APP_URL: ${{ secrets.STREAMLIT_APP_URL }}
        run: |
          BASE="${APP_URL%/}"
          echo "Pinging ${BASE} ..."

          # 不加 -L，不追蹤重定向，收到任何 HTTP 回應都算成功
          # Streamlit 只要收到流量就不會進入休眠，無需確認 200
          CODE=$(curl -s -o /dev/null -w "%{http_code}" \
            --max-time 30 --connect-timeout 10 \
            "${BASE}" 2>/dev/null) || CODE="000"

          echo "HTTP response: ${CODE}"

          if [ "${CODE}" = "000" ]; then
            echo "No response - network error"
            exit 1
          else
            echo "Ping delivered (HTTP ${CODE}) - app will stay awake"
          fi

          echo "### Streamlit Keepalive" >> "$GITHUB_STEP_SUMMARY"
          echo "| | |" >> "$GITHUB_STEP_SUMMARY"
          echo "|---|---|" >> "$GITHUB_STEP_SUMMARY"
          echo "| Time | $(date -u '+%Y-%m-%d %H:%M UTC') |" >> "$GITHUB_STEP_SUMMARY"
          echo "| HTTP | ${CODE} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Result | Ping delivered |" >> "$GITHUB_STEP_SUMMARY"
