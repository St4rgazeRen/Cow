name: Streamlit Keepalive (防休眠 Ping)

# 使用 /_stcore/health 健康端點，不走認證跳轉
# 設定: GitHub Repo Settings -> Secrets -> Actions
#       STREAMLIT_APP_URL = https://mfyyo9qf5mymsrouxkfdgj.streamlit.app
#       (結尾不要加斜線 /)

on:
  schedule:
    - cron: '0 0 * * *'   # UTC 00:00 (台灣 08:00)
    - cron: '0 12 * * *'  # UTC 12:00 (台灣 20:00)
  workflow_dispatch:

jobs:
  ping:
    name: Ping Streamlit App
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Ping health endpoint
        env:
          APP_URL: ${{ secrets.STREAMLIT_APP_URL }}
        run: |
          # 去除尾端斜線，避免 //stcore/health 雙斜線問題
          BASE="${APP_URL%/}"
          HEALTH="${BASE}/_stcore/health"
          echo "Target: ${HEALTH}"

          # -L --max-redirs 3: 僅跟隨 URL 正規化的 301 (無認證循環風險)
          CODE=$(curl -s -L --max-redirs 3 \
            -o /tmp/body.txt -w "%{http_code}" \
            --max-time 60 --connect-timeout 10 \
            "${HEALTH}" 2>/dev/null)
          CODE="${CODE:-000}"
          BODY=$(cat /tmp/body.txt 2>/dev/null | head -c 100)
          echo "HTTP ${CODE} | ${BODY}"

          if [ "${CODE}" = "200" ]; then
            echo "App is running (HTTP 200)"
          elif [ "${CODE}" = "503" ]; then
            echo "App sleeping, waiting 60s..."
            sleep 60
            CODE=$(curl -s -L --max-redirs 3 \
              -o /tmp/body2.txt -w "%{http_code}" \
              --max-time 90 --connect-timeout 10 \
              "${HEALTH}" 2>/dev/null)
            CODE="${CODE:-000}"
            echo "Retry HTTP ${CODE}"
            if [ "${CODE}" = "200" ]; then
              echo "App woke up"
            else
              echo "Still waking (${CODE}), next ping will continue"
            fi
          else
            echo "Unexpected: ${CODE}"
            exit 1
          fi

          echo "### Streamlit Keepalive" >> "$GITHUB_STEP_SUMMARY"
          echo "| | |" >> "$GITHUB_STEP_SUMMARY"
          echo "|---|---|" >> "$GITHUB_STEP_SUMMARY"
          echo "| Time | $(date -u '+%Y-%m-%d %H:%M UTC') |" >> "$GITHUB_STEP_SUMMARY"
          echo "| HTTP | ${CODE} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Endpoint | \`/_stcore/health\` |" >> "$GITHUB_STEP_SUMMARY"
