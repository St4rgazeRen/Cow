name: Streamlit Keepalive (é˜²ä¼‘çœ  Ping)

# ==============================================================================
# ç›®çš„: Streamlit Community Cloud å…è²»ç‰ˆ 7 å¤©ç„¡äººè¨ªå•å¾Œæœƒé€²å…¥ä¼‘çœ 
#       æ­¤ Workflow æ¯ 24 å°æ™‚è‡ªå‹• Ping ä¸€æ¬¡ Appï¼Œé˜²æ­¢ä¼‘çœ 
# è¨­å®š: è«‹åœ¨ GitHub Repo Settings â†’ Secrets â†’ Actions åŠ å…¥:
#       STREAMLIT_APP_URL = https://mfyyo9qf5mymsrouxkfdgj.streamlit.app/
# æ³¨æ„: curl å¿…é ˆåŠ  -L è¿½è¹¤ HTTP 302/303 é‡å®šå‘ï¼Œå¦å‰‡ Streamlit ä¸æœƒè¨˜éŒ„ç‚ºã€Œè¨ªå•ã€
# ==============================================================================

on:
  schedule:
    # æ¯å¤© UTC 00:00 / 12:00 å„åŸ·è¡Œä¸€æ¬¡ (å°ç£æ™‚é–“ 08:00 / 20:00)
    - cron: '0 0 * * *'
    - cron: '0 12 * * *'
  workflow_dispatch:  # å…è¨±æ‰‹å‹•è§¸ç™¼æ¸¬è©¦

jobs:
  ping:
    name: Ping Streamlit App
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: æª¢æŸ¥ STREAMLIT_APP_URL æ˜¯å¦å·²è¨­å®š
        run: |
          if [ -z "${{ secrets.STREAMLIT_APP_URL }}" ]; then
            echo "âš ï¸  STREAMLIT_APP_URL æœªè¨­å®šï¼Œè«‹è‡³ Repo Settings â†’ Secrets â†’ Actions æ–°å¢ž"
            exit 1
          fi
          echo "âœ… STREAMLIT_APP_URL å·²è¨­å®š"

      - name: Ping App (è¿½è¹¤é‡å®šå‘ + ç­‰å¾…å–šé†’)
        id: ping_main
        env:
          APP_URL: ${{ secrets.STREAMLIT_APP_URL }}
        run: |
          echo "ðŸŒ æ­£åœ¨é€£æŽ¥ Streamlit App..."

          # -L: è¿½è¹¤ 302/303 é‡å®šå‘ï¼ˆé—œéµï¼ä¸åŠ æ­¤æ——æ¨™ Streamlit ä¸ç®—ä½œè¨ªå•ï¼‰
          HTTP_CODE=$(curl -s -L -o /dev/null -w "%{http_code}" \
            --max-time 90 \
            --connect-timeout 15 \
            -H "User-Agent: Mozilla/5.0 (compatible; StreamlitKeepAlive/1.0)" \
            "${APP_URL}")

          # ç¢ºä¿ HTTP_CODE ä¸ç‚ºç©º
          HTTP_CODE="${HTTP_CODE:-000}"
          echo "æœ€çµ‚ HTTP ç‹€æ…‹ç¢¼: ${HTTP_CODE}"

          # å¯«å…¥ step outputï¼ˆç”¨ env: å€å¡Šå‚³éž secretï¼Œé¿å…è¡¨é”å¼æå‰å±•é–‹å•é¡Œï¼‰
          echo "http_code=${HTTP_CODE}" >> "$GITHUB_OUTPUT"

          if [[ "${HTTP_CODE}" -ge 200 && "${HTTP_CODE}" -lt 400 ]]; then
            echo "âœ… App å›žæ‡‰æ­£å¸¸ (HTTP ${HTTP_CODE}) â€” é˜²ä¼‘çœ æˆåŠŸ"
            echo "status=success" >> "$GITHUB_OUTPUT"
          elif [[ "${HTTP_CODE}" -eq 503 || "${HTTP_CODE}" -eq 502 ]]; then
            echo "ðŸ˜´ App æ­£åœ¨å–šé†’ (HTTP ${HTTP_CODE})ï¼Œç­‰å¾… 60 ç§’å¾Œé‡è©¦..."
            sleep 60
            HTTP_CODE=$(curl -s -L -o /dev/null -w "%{http_code}" \
              --max-time 120 \
              -H "User-Agent: Mozilla/5.0 (compatible; StreamlitKeepAlive/1.0)" \
              "${APP_URL}")
            HTTP_CODE="${HTTP_CODE:-000}"
            echo "é‡è©¦å¾Œ HTTP ç‹€æ…‹ç¢¼: ${HTTP_CODE}"
            echo "http_code=${HTTP_CODE}" >> "$GITHUB_OUTPUT"
            if [[ "${HTTP_CODE}" -ge 200 && "${HTTP_CODE}" -lt 400 ]]; then
              echo "âœ… App å–šé†’æˆåŠŸ (HTTP ${HTTP_CODE})"
              echo "status=success" >> "$GITHUB_OUTPUT"
            else
              echo "status=failed" >> "$GITHUB_OUTPUT"
              echo "âŒ App å–šé†’å¤±æ•— (HTTP ${HTTP_CODE})" && exit 1
            fi
          else
            echo "status=failed" >> "$GITHUB_OUTPUT"
            echo "âŒ App å›žæ‡‰ç•°å¸¸ (HTTP ${HTTP_CODE})" && exit 1
          fi

      - name: è¨˜éŒ„ Ping çµæžœæ‘˜è¦
        if: always()
        env:
          PING_CODE: ${{ steps.ping_main.outputs.http_code }}
          PING_STATUS: ${{ steps.ping_main.outputs.status }}
        run: |
          STATUS_ICON="â“"
          [[ "${PING_STATUS}" == "success" ]] && STATUS_ICON="âœ… æˆåŠŸ"
          [[ "${PING_STATUS}" == "failed" ]]  && STATUS_ICON="âŒ å¤±æ•—"

          echo "### ðŸ¤– Streamlit Keepalive å ±å‘Š" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "| é …ç›® | çµæžœ |" >> "$GITHUB_STEP_SUMMARY"
          echo "|------|------|" >> "$GITHUB_STEP_SUMMARY"
          echo "| åŸ·è¡Œæ™‚é–“ | $(date -u '+%Y-%m-%d %H:%M UTC') |" >> "$GITHUB_STEP_SUMMARY"
          echo "| æœ€çµ‚ HTTP ç‹€æ…‹ | **${PING_CODE:-æœªå–å¾—}** |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Ping çµæžœ | ${STATUS_ICON} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| é‡å®šå‘è¿½è¹¤ | âœ… å·²å•Ÿç”¨ (-L flag) |" >> "$GITHUB_STEP_SUMMARY"
